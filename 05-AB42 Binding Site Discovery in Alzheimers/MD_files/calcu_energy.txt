#!/bin/bash
#SBATCH --time=1:00:00   # walltime
#SBATCH --ntasks=8  # number of processor cores (i.e. tasks)
#SBATCH --nodes=1   # number of nodes
#SBATCH --gres=gpu:0
#SBATCH --mem-per-cpu=1G   # memory per CPU core
#SBATCH --partition=expansion
#SBATCH -J "WT"   # job name
#SBATCH --qos=normal

#load the modules from RHEL9
module load cuda
module load openmpi
module load plumed
module load gromacs/2022.3-gcc-11.3.1-7bjvc63
export OMP_NUM_THREADS=2

#bash makendx_LR.sh || { echo "Error making the ligand and receptor index $dir"; exit 1; }

# make the energy mdp file
#mdp_add_energy_groups "prod_1ns.mdp" "prod_energy_groups.mdp" "Ligand Receptor " || { echo "Error making mdp file for the rerun $dir"; exit 1; }

# make index.ndx and protein together
#cat index.ndx protein.ndx > receptor_ligand.ndx

# make the new tpr for energy rerun 

gmx_mpi grompp -f prod_energy_groups.mdp -c md_2.gro -p topol.top -o poly_solv_prod_energy_groups.tpr -n receptor_ligand.ndx -maxwarn 5

# rerun MD

srun gmx_mpi mdrun -s poly_solv_prod_energy_groups.tpr -rerun md_2.xtc  -e poly_solv_prod_energy_groups.edr -ntomp $OMP_NUM_THREADS -dlb auto -v

# export the energy group 
echo 22 23 24 25 0 | gmx_mpi energy -f poly_solv_prod_energy_groups.edr -s poly_solv_prod_energy_groups.tpr -o energy_groups.xvg
